{ storage
    (pair (pair %my_map
             (big_map %values string (pair (nat %index) (bytes %value)))
             (big_map %keys nat string)
             (nat %size))
          (bytes %res_concat)) ;
  parameter (or (or (pair %put (string %k) (bytes %v)) (string %remove)) (unit %iterate)) ;
  code { UNPAIR ;
         DIP 1 { UNPAIR } ;
         IF_LEFT
           { IF_LEFT
               { UNPAIR ;
                 SWAP ;
                 DUP 3 ;
                 PUSH nat 1 ;
                 DUP 2 ;
                 GET 4 ;
                 ADD ;
                 DUP 2 ;
                 GET 1 ;
                 DUP 5 ;
                 GET ;
                 IF_NONE
                   { DUP 2 ;
                     DUP 2 ;
                     UPDATE 4 ;
                     DIP 1 { SWAP ; DROP 1 } ;
                     SWAP ;
                     DUP 2 ;
                     DUP 3 ;
                     GET 3 ;
                     DUP 6 ;
                     SOME ;
                     DUP 5 ;
                     GET 4 ;
                     UPDATE ;
                     UPDATE 3 ;
                     DIP 1 { SWAP ; DROP 1 } ;
                     SWAP }
                   { DUP ; GET 1 ; DIP 1 { SWAP ; DROP 1 } ; SWAP ; DROP 1 } ;
                 DUP 2 ;
                 DUP 3 ;
                 GET 1 ;
                 DUP 5 ;
                 DUP 4 ;
                 PAIR ;
                 SOME ;
                 DUP 7 ;
                 UPDATE ;
                 UPDATE 1 ;
                 DIP 1 { SWAP ; DROP 1 } ;
                 SWAP ;
                 DUP 2 ;
                 DIP 1 { DIG 4 ; DROP 1 } ;
                 DUG 4 ;
                 DROP 4 ;
                 PAIR ;
                 NIL operation ;
                 PAIR }
               { DUP 2 ;
                 DUP ;
                 GET 1 ;
                 DUP 3 ;
                 GET ;
                 IF_NONE
                   {}
                   { DUP ;
                     GET 1 ;
                     DUP 3 ;
                     GET 3 ;
                     DUP 4 ;
                     GET 4 ;
                     GET ;
                     IF_NONE { PUSH string "NOT_FOUND" ; FAILWITH } {} ;
                     DUP 4 ;
                     GET 1 ;
                     DUP 2 ;
                     GET ;
                     IF_NONE { PUSH string "NOT_FOUND" ; FAILWITH } {} ;
                     DUP 5 ;
                     DUP 6 ;
                     GET 3 ;
                     DUP 4 ;
                     SOME ;
                     DUP 6 ;
                     UPDATE ;
                     UPDATE 3 ;
                     DIP 1 { DIG 4 ; DROP 1 } ;
                     DUG 4 ;
                     DUP 5 ;
                     DUP 6 ;
                     GET 1 ;
                     DUP 3 ;
                     GET 2 ;
                     DUP 6 ;
                     PAIR ;
                     SOME ;
                     DUP 5 ;
                     UPDATE ;
                     UPDATE 1 ;
                     DIP 1 { DIG 4 ; DROP 1 } ;
                     DUG 4 ;
                     DUP 5 ;
                     DUP 6 ;
                     GET 3 ;
                     NONE string ;
                     DUP 8 ;
                     GET 4 ;
                     UPDATE ;
                     UPDATE 3 ;
                     DIP 1 { DIG 4 ; DROP 1 } ;
                     DUG 4 ;
                     DUP 5 ;
                     PUSH nat 1 ;
                     DUP 7 ;
                     GET 4 ;
                     SUB ;
                     ISNAT ;
                     IF_NONE { PUSH string "OPTION_IS_NONE" ; FAILWITH } {} ;
                     UPDATE 4 ;
                     DIP 1 { DIG 4 ; DROP 1 } ;
                     DUG 4 ;
                     DUP 5 ;
                     DUP 6 ;
                     GET 1 ;
                     NONE (pair nat bytes) ;
                     DUP 9 ;
                     UPDATE ;
                     UPDATE 1 ;
                     DIP 1 { DIG 4 ; DROP 1 } ;
                     DUG 4 ;
                     DUP 5 ;
                     DIP 1 { DIG 6 ; DROP 1 } ;
                     DUG 6 ;
                     DROP 4 } ;
                 DROP 2 ;
                 PAIR ;
                 NIL operation ;
                 PAIR } }
           { DROP 1 ;
             PUSH bytes 0x ;
             DIP 1 { SWAP ; DROP 1 } ;
             SWAP ;
             DUP ;
             DUP ;
             GET 4 ;
             PUSH nat 1 ;
             DUP 2 ;
             DUP 2 ;
             COMPARE ;
             LE ;
             LOOP { DUP 3 ;
                    GET 3 ;
                    DUP 2 ;
                    GET ;
                    IF_NONE { PUSH string "NOT_FOUND" ; FAILWITH } {} ;
                    DUP 4 ;
                    GET 1 ;
                    DUP 2 ;
                    GET ;
                    IF_NONE { PUSH string "NOT_FOUND" ; FAILWITH } {} ;
                    CDR ;
                    DUP ;
                    DUP 8 ;
                    CONCAT ;
                    DIP 1 { DIG 6 ; DROP 1 } ;
                    DUG 6 ;
                    DROP 2 ;
                    PUSH nat 1 ;
                    DUP 2 ;
                    ADD ;
                    SWAP ;
                    DROP 1 ;
                    DUP 2 ;
                    DUP 2 ;
                    COMPARE ;
                    LE } ;
             DROP 3 ;
             PAIR ;
             NIL operation ;
             PAIR } } }
